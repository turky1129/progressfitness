<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>ProgressFit</title>

  <!-- PWA / icons (置いてあるなら効く) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ProgressFit" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- jsPDF (client-side PDF generation) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- Vue 3 (CDN / single-file HTML compatible) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --border: rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:#9fb0d6;
      --good:#7CFF8C;
      --bad:#ff6a7a;
      --radius:16px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 30% -10%, rgba(106,227,255,.18), transparent 55%),
        radial-gradient(900px 700px at 110% 10%, rgba(167,139,250,.18), transparent 60%),
        var(--bg);
      padding: 14px 12px 14px;
    }
    .phone{
      max-width: 430px;
      margin: 0 auto;
      min-height: calc(100dvh - 28px);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .top{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .brand{display:flex; gap:10px; align-items:center; min-width:0}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:linear-gradient(135deg,rgba(106,227,255,.28),rgba(167,139,250,.22));
      box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .titlewrap{min-width:0}
    .title{font-size:18px; font-weight:900; margin:0; line-height:1.2}
    .sub{font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .actions{display:flex; gap:8px; align-items:center; flex:0 0 auto}
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      line-height:1;
      user-select:none;
    }
    .chip b{color:var(--text)}
    .chipBtn{
      cursor:pointer;
      color: var(--text);
      background: rgba(106,227,255,.12);
      border-color: rgba(106,227,255,.22);
    }

    .seg{
      display:flex;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:999px;
      padding:6px;
      gap:6px;
    }
    .seg button{
      border:0; background:transparent;
      color:var(--muted);
      font-weight:900;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      line-height:1;
      flex:1;
    }
    .seg button.active{
      color:var(--text);
      background: rgba(106,227,255,.18);
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
      min-height:86px;
    }
    .khead{display:flex; justify-content:space-between; align-items:baseline; gap:8px}
    .klabel{font-size:12px;color:var(--muted);font-weight:900}
    .kdelta{font-size:12px;font-weight:950}
    .kval{display:flex; align-items:baseline; gap:8px; margin-top:6px}
    .knum{font-size:26px;font-weight:1000; letter-spacing:.2px}
    .kunit{font-size:12px;color:var(--muted);font-weight:900}

    .panel{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      padding:10px;
      box-shadow: var(--shadow);
      flex:1;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .tabs{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-bottom:6px;
    }
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      line-height:1;
      user-select:none;
    }
    .tab.active{
      color: var(--text);
      background: rgba(167,139,250,.16);
      border-color: rgba(167,139,250,.30);
    }

    #metricTitle{
      display:none;
      font-size:14px;
      font-weight:1000;
      margin: 2px 0 6px;
      color: var(--text);
    }

    .chartWrap{ position:relative; flex:1; min-height:0; }
    #trendView{ padding-bottom: calc(30px + env(safe-area-inset-bottom)); }
    canvas{width:100% !important; height:100% !important}

    #moreView{ flex:1; min-height:0; overflow:auto; }

    .viewSeg{ margin-top:auto; }

    .moreGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding-top:4px;
    }

    .importExport{
      margin-top: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .moreItem{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px;
      cursor:pointer;
      user-select:none;
    }
    .moreName{font-size:12px;color:var(--muted);font-weight:900}
    .moreVal{margin-top:6px;font-size:18px;font-weight:1000}
    .moreUnit{font-size:12px;color:var(--muted);font-weight:900;margin-left:6px}
    .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.4}

    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 50;
    }
    .modal{
      width:min(430px, 100%);
      border:1px solid var(--border);
      background: rgba(12,18,32,.92);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .mTitle{font-size:14px;font-weight:1000;margin:2px 0 10px}
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px;
    }
    .field.full{ grid-column: 1 / -1; }
    .field label{display:block;font-size:12px;color:var(--muted);font-weight:900;margin-bottom:6px}
    .field input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:16px;
      font-weight:950;
    }
    .mActions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 999px;
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
      line-height:1;
      user-select:none;
    }
    .btnPrimary{
      background: rgba(106,227,255,.14);
      border-color: rgba(106,227,255,.30);
    }
    .btnDanger{
      background: rgba(255,106,122,.12);
      border-color: rgba(255,106,122,.25);
    }

    .listRow{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .listMain{font-size:13px; line-height:1.4}
    .listDate{font-weight:1000}
    .listSub{color:var(--muted); font-size:12px}
    .listActions{display:flex; align-items:center}
    .listEdit{
      border:0;
      background: rgba(106,227,255,.15);
      color: var(--text);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }

    .safeBottom{height: env(safe-area-inset-bottom);}
  </style>
</head>

<body>
<div id="app" class="phone">
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div class="titlewrap">
        <div class="title">ProgressFit</div>
        <div class="sub">{{ subtitle }}</div>
      </div>
    </div>
    <div class="actions">
      <div class="chip chipBtn" @click="openList">件数 <b>{{ filteredRows.length }}</b></div>
      <div class="chip chipBtn" @click="openTargetsModal">目標</div>
      <div class="chip chipBtn" @click="openAddModal">＋データ</div>
    </div>
  </div>

  <div class="seg" id="rangeSeg">
    <button :class="{active: currentRange==='all'}" @click="setRange('all')">全期間</button>
    <button :class="{active: currentRange==='1y'}" @click="setRange('1y')">1年</button>
    <button :class="{active: currentRange==='3m'}" @click="setRange('3m')">3ヶ月</button>
  </div>

  <div class="kpis">
    <div class="kpi" v-for="k in kpiItems" :key="k.key">
      <div class="khead">
        <div class="klabel">{{ k.label }}</div>
        <div class="kdelta" :style="{color: k.deltaColor }">{{ k.deltaText }}</div>
      </div>
      <div class="kval">
        <div class="knum">{{ k.valueText }}</div>
        <div class="kunit" v-if="k.unit">{{ k.unit }}</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div id="metricTitle" v-show="currentView==='trend' && !showMetricTabs">{{ metricTitleText }}</div>

    <div class="tabs" v-show="currentView==='trend' && showMetricTabs" id="metricTabs">
      <div
        class="tab"
        v-for="m in MAIN_METRICS"
        :key="m"
        :class="{active: currentMetric===m}"
        @click="selectMetric(m)"
      >{{ METRICS[m].name }}</div>
    </div>

    <div class="chartWrap" id="trendView" v-show="currentView==='trend'">
      <canvas ref="trendCanvas"></canvas>
    </div>

    <div class="chartWrap" id="bodyMapView" v-show="currentView==='bodymap'">
      <canvas ref="bodyMapCanvas"></canvas>
    </div>

    <div id="moreView" v-show="currentView==='more'">
      <div class="moreGrid" id="moreGrid">
        <div class="moreItem" v-for="key in MORE_METRICS" :key="key" @click="openMetricFromMore(key)">
          <div class="moreName">{{ METRICS[key].name }}</div>
          <div class="moreVal">
            {{ fmt1(latestRow && latestRow[key]) }}<span class="moreUnit" v-if="METRICS[key].unit">{{ METRICS[key].unit }}</span>
          </div>
        </div>
      </div>

      <div class="importExport">
        <div class="chip chipBtn" @click="exportCsv">エクスポート</div>
        <div class="chip chipBtn" @click="triggerImport">インポート</div>
        <div class="chip chipBtn" @click="exportPdf">PDF出力</div>
        <input type="file" ref="importInput" accept=".csv" style="display:none;" @change="handleImportChange">
      </div>
    </div>

    <div class="seg viewSeg" id="viewSeg">
      <button :class="{active: currentView==='trend'}" @click="setView('trend','direct')">Trend</button>
      <button :class="{active: currentView==='bodymap'}" @click="setView('bodymap','direct')">BodyMap</button>
      <button :class="{active: currentView==='more'}" @click="setView('more','direct')">More</button>
    </div>
  </div>

  <div class="safeBottom"></div>

  <!-- Targets Modal -->
  <div class="modalBg" :style="{display: showTargets ? 'flex' : 'none'}" @click.self="closeTargetsModal">
    <div class="modal">
      <div class="mTitle">目標値（保存されます）</div>
      <div class="form">
        <div class="field">
          <label>体重 目標 (kg)</label>
          <input v-model="targetsForm.weight_kg" inputmode="decimal" />
        </div>
        <div class="field">
          <label>BMI 目標</label>
          <input v-model="targetsForm.bmi" inputmode="decimal" />
        </div>
        <div class="field">
          <label>ウエスト 目標 (cm)</label>
          <input v-model="targetsForm.waist_cm" inputmode="decimal" />
        </div>
        <div class="field">
          <label>体脂肪率 目標 (%)</label>
          <input v-model="targetsForm.bodyfat_pct" inputmode="decimal" />
        </div>
        <div class="field full">
          <label>身長 (cm) ※BMI自動計算に使う（任意）</label>
          <input v-model="targetsForm.height_cm" inputmode="decimal" placeholder="例: 175" />
        </div>
      </div>
      <div class="mActions">
        <button class="btn" @click="closeTargetsModal">キャンセル</button>
        <button class="btn btnPrimary" @click="saveTargets">保存</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modalBg" :style="{display: showAdd ? 'flex' : 'none'}" @click.self="closeAddModal">
    <div class="modal">
      <div class="mTitle">{{ addTitle }}</div>
      <div class="form">
        <div class="field full">
          <label>日付</label>
          <input v-model="form.date" type="date" />
        </div>

        <div class="field">
          <label>体重 (kg) *</label>
          <input v-model="form.weight_kg" inputmode="decimal" />
        </div>
        <div class="field">
          <label>体脂肪率 (%) *</label>
          <input v-model="form.bodyfat_pct" inputmode="decimal" />
        </div>

        <div class="field">
          <label>BMI（空なら身長から計算）</label>
          <input v-model="form.bmi" inputmode="decimal" placeholder="任意" />
        </div>
        <div class="field">
          <label>ウエスト (cm) *</label>
          <input v-model="form.waist_cm" inputmode="decimal" placeholder="例: 86.0" />
        </div>

        <div class="field">
          <label>体脂肪量 (kg)</label>
          <input v-model="form.fatmass_kg" inputmode="decimal" placeholder="任意" />
        </div>
        <div class="field">
          <label>内臓脂肪指数</label>
          <input v-model="form.visceral_fat_index" inputmode="decimal" placeholder="任意" />
        </div>

        <div class="field">
          <label>骨格筋量 (kg)</label>
          <input v-model="form.skeletal_muscle_kg" inputmode="decimal" placeholder="任意" />
        </div>
        <div class="field">
          <label>基礎代謝量 (kcal)</label>
          <input v-model="form.bmr_kcal" inputmode="decimal" placeholder="任意" />
        </div>

        <div class="field full">
          <label>四肢の除脂肪量 (kg)</label>
          <input v-model="form.limb_lean_mass_kg" inputmode="decimal" placeholder="任意" />
        </div>

        <div class="field">
          <label>筋肉量 (kg)</label>
          <input v-model="form.muscle_kg" inputmode="decimal" placeholder="任意（旧データ用）" />
        </div>
        <div class="field">
          <label>フィットネススコア (pt)</label>
          <input v-model="form.fitness_score" inputmode="decimal" placeholder="任意（旧データ用）" />
        </div>
      </div>

      <div class="hint">※必須：日付 / 体重 / 体脂肪率 / ウエスト（BMIは身長が設定されていれば自動）。他は任意。</div>

      <div class="mActions">
        <button class="btn" @click="closeAddModal">キャンセル</button>
        <button class="btn btnDanger" v-if="editMode" @click="deleteOne">この1件を削除</button>
        <button class="btn btnPrimary" @click="saveAdd">保存</button>
      </div>
    </div>
  </div>

  <!-- List Modal -->
  <div class="modalBg" :style="{display: showList ? 'flex' : 'none'}" @click.self="closeList">
    <div class="modal">
      <div class="mTitle">記録一覧</div>
      <div style="max-height:60vh;overflow:auto;">
        <div class="listRow" v-for="r in listRows" :key="r.date">
          <div class="listMain">
            <div class="listDate">{{ r.date }}</div>
            <div class="listSub">
              {{ fmt1(r.weight_kg) }}kg / BMI {{ fmt1(r.bmi) }} / {{ fmt1(r.waist_cm) }}cm / {{ fmt1(r.bodyfat_pct) }}%
            </div>
          </div>
          <div class="listActions">
            <button class="listEdit" @click="editRow(r)">更新</button>
          </div>
        </div>
      </div>
      <div class="mActions">
        <button class="btn" @click="closeList">閉じる</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===============================
   ProgressFit Vue3 Single-HTML
   =============================== */

/* ===== Base CSV（内包データ） ===== */
const BASE_CSV = `date,weight_kg,bmi,waist_cm,fatmass_kg,visceral_fat_index,bodyfat_pct,skeletal_muscle_kg,bmr_kcal,limb_lean_mass_kg
2025-10-03,86.15,29.5,,37.65,85.0,43.7,23.5,1630,19.7
2025-10-06,87.3,29.9,,38.2,,43.8,,1567,
2025-10-10,86.45,29.6,,38.85,115.0,45.0,22.75,1623,19.2
2025-10-17,85.0,29.1,95.5,37.05,90.0,43.6,23.25,1614,19.35
2025-10-21,85.6,29.3,,36.1,90.0,42.2,24.05,1636,19.0
2025-10-24,84.3,28.7,94.5,36.8,85.0,43.8,22.55,1595,18.9
2025-10-31,83.35,28.5,93.0,35.3,85.0,42.3,23.4,1599,19.1
2025-11-05,83.4,28.5,92.0,35.7,80.0,42.8,22.8,1596,18.9
2025-11-08,82.4,28.2,,35.25,80.0,42.8,22.65,1581,18.65
2025-11-15,82.2,28.1,,34.45,80.0,41.9,22.95,1585,19.05
2025-11-22,81.4,27.8,91.0,33.85,75.0,41.6,22.9,1576,18.95
2025-11-28,80.4,27.5,90.0,33.4,75.0,41.6,22.35,1560,18.5
2025-12-05,79.2,27.1,,32.8,75.0,41.4,22.2,1543,18.05
2025-12-10,79.35,27.1,,32.3,75.0,40.7,22.65,1551,18.5
2025-12-20,78.8,26.9,88.0,31.25,65.0,39.6,22.55,1551,18.8
2025-12-27,77.6,26.5,86.0,30.0,65.0,38.7,23.25,1540,18.65`;

/* ===== configs ===== */
const METRICS = {
  weight_kg:           { name:'体重', unit:'kg' },
  bmi:                 { name:'BMI', unit:'' },
  waist_cm:            { name:'ウエスト', unit:'cm' },
  bodyfat_pct:         { name:'体脂肪率', unit:'%'  },
  fatmass_kg:          { name:'体脂肪量', unit:'kg' },
  visceral_fat_index:  { name:'内臓脂肪指数', unit:'' },
  skeletal_muscle_kg:  { name:'骨格筋量', unit:'kg' },
  bmr_kcal:            { name:'基礎代謝量', unit:'kcal' },
  limb_lean_mass_kg:   { name:'四肢の除脂肪量', unit:'kg' },
  muscle_kg:           { name:'筋肉量', unit:'kg' },
  fitness_score:       { name:'フィットネススコア', unit:'pt' },
};
const MAIN_METRICS = ['weight_kg','bmi','waist_cm','bodyfat_pct'];
const MORE_METRICS = ['fatmass_kg','visceral_fat_index','skeletal_muscle_kg','bmr_kcal','limb_lean_mass_kg','muscle_kg','fitness_score'];

/* ===== storage keys ===== */
const TARGET_KEY_NEW  = 'progressfit_targets_v3';
const TARGET_KEY_OLD  = 'progressfit_targets_v2'; // 旧（あれば読み取り移行）
const ADDS_KEY        = 'progressfit_added_rows_v1';
const DELETED_KEY     = 'progressfit_deleted_dates_v1';

/* ===== utils ===== */
function fmt1(x){ return Number.isFinite(x) ? (Math.round(x*10)/10).toFixed(1) : '—'; }
function numOrNull(v){ return (v===undefined||v===null||v==='') ? null : Number(v); }
function normDate(v){
  if(v===undefined||v===null) return '';
  const s = String(v).trim();
  return s ? s.split(' ')[0] : '';
}
function normalizeRow(r){
  if(!r) return null;
  const date = normDate(r.date ?? r['測定日'] ?? r['日付']);
  if(!date) return null;
  return {
    date,
    weight_kg:          numOrNull(r.weight_kg ?? r['体重(㎏)']),
    bmi:                numOrNull(r.bmi ?? r['BMI']),
    waist_cm:           numOrNull(r.waist_cm ?? r['ウエスト']),
    fatmass_kg:         numOrNull(r.fatmass_kg ?? r['体脂肪量(㎏)']),
    visceral_fat_index: numOrNull(r.visceral_fat_index ?? r.visceral_fat_level ?? r['内臓脂肪指数'] ?? r['内臓脂肪レベル']),
    bodyfat_pct:        numOrNull(r.bodyfat_pct ?? r['体脂肪率(％)'] ?? r['体脂肪率(%)']),
    skeletal_muscle_kg: numOrNull(r.skeletal_muscle_kg ?? r['骨格筋量(㎏)']),
    bmr_kcal:           numOrNull(r.bmr_kcal ?? r['基礎代謝量(kcal)']),
    limb_lean_mass_kg:  numOrNull(r.limb_lean_mass_kg ?? r['四肢の除脂肪量(㎏)'] ?? r['四股の除脂肪量(㎏)']),
    muscle_kg:          numOrNull(r.muscle_kg ?? r['筋肉量(㎏)'] ?? r['筋肉量']),
    fitness_score:      numOrNull(r.fitness_score ?? r['フィットネススコア'] ?? r['フィットネススコア(pt)'] ?? r['フィットネススコア (pt)']),
  };
}

function parseCsvGeneric(csvText){
  const text = (csvText||'').trim();
  if(!text) return [];
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length<2) return [];
  const header = lines[0].split(',').map(h=>h.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++) {
    const cols = lines[i].split(',');
    const obj = {};
    for(let j=0;j<header.length;j++) obj[header[j]] = (cols[j] ?? '').trim();
    const n = normalizeRow(obj);
    if(n) rows.push(n);
  }
  return rows;
}

const baseRows = parseCsvGeneric(BASE_CSV);

/* ===== localStorage helpers ===== */
function loadJson(key){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function saveJson(key, v){ localStorage.setItem(key, JSON.stringify(v)); }

function loadAdds(){
  const arr = loadJson(ADDS_KEY);
  return Array.isArray(arr) ? arr.map(normalizeRow).filter(Boolean) : [];
}
function saveAdds(arr){ saveJson(ADDS_KEY, arr); }

function loadDeleted(){
  const arr = loadJson(DELETED_KEY);
  return Array.isArray(arr) ? arr.map(normDate).filter(Boolean) : [];
}
function saveDeleted(arr){ saveJson(DELETED_KEY, arr); }

function loadTargets(){
  const def = {
    weight_kg: 75.0,
    bmi: null,
    waist_cm: null,
    bodyfat_pct: 20.0,
    height_cm: null
  };
  const cur = loadJson(TARGET_KEY_NEW);
  if(cur) return {...def, ...cur};
  // 旧ターゲットがあるなら軽く移行
  const old = loadJson(TARGET_KEY_OLD);
  if(old){
    const migrated = {
      ...def,
      weight_kg: Number.isFinite(+old.weight_kg) ? +old.weight_kg : def.weight_kg,
      bodyfat_pct: Number.isFinite(+old.bodyfat_pct) ? +old.bodyfat_pct : def.bodyfat_pct,
      height_cm: (Number.isFinite(+old.height_cm) && +old.height_cm>0) ? +old.height_cm : null
    };
    saveJson(TARGET_KEY_NEW, migrated);
    return migrated;
  }
  return def;
}

/* ===== merge ===== */
function mergeRows(){
  const adds = loadAdds();
  const deleted = new Set(loadDeleted());

  const map = new Map();
  for(const r of baseRows){
    if(!deleted.has(r.date)) map.set(r.date, r);
  }
  for(const r of adds){
    if(!deleted.has(r.date)) map.set(r.date, r);
  }
  return Array.from(map.values()).sort((a,b)=>a.date.localeCompare(b.date));
}

const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue;

createApp({
  setup(){
    const rows = ref(mergeRows());

    const currentRange = ref('all');
    const currentMetric = ref('weight_kg');
    const currentView = ref('trend'); // trend | bodymap | more
    const showMetricTabs = ref(true);

    const targets = reactive(loadTargets());

    // Modals
    const showTargets = ref(false);
    const showAdd = ref(false);
    const showList = ref(false);

    // Add/Edit
    const editMode = ref(false);
    const editOriginalDate = ref(null);

    const emptyForm = () => ({
      date: '',
      weight_kg: '',
      bmi: '',
      waist_cm: '',
      bodyfat_pct: '',
      fatmass_kg: '',
      visceral_fat_index: '',
      skeletal_muscle_kg: '',
      bmr_kcal: '',
      limb_lean_mass_kg: '',
      muscle_kg: '',
      fitness_score: ''
    });
    const form = reactive(emptyForm());

    const addTitle = computed(()=> editMode.value ? 'データ更新' : 'データ追加');

    // Targets form (string bind)
    const targetsForm = reactive({
      weight_kg: '',
      bmi: '',
      waist_cm: '',
      bodyfat_pct: '',
      height_cm: ''
    });

    const trendCanvas = ref(null);
    const bodyMapCanvas = ref(null);
    const importInput = ref(null);

    // --- Derived ---
    const filteredRows = computed(()=>{
      const all = rows.value;
      if(!all.length) return [];
      if(currentRange.value === 'all') return all;
      const end = new Date(all.at(-1).date);
      const start = new Date(end);
      if(currentRange.value === '1y') start.setFullYear(start.getFullYear()-1);
      if(currentRange.value === '3m') start.setMonth(start.getMonth()-3);
      return all.filter(r => new Date(r.date) >= start);
    });

    const subtitle = computed(()=>{
      const data = filteredRows.value;
      if(!data.length) return '—';
      return `${data[0].date} → ${data.at(-1).date}`;
    });

    const latestRow = computed(()=>{
      const data = filteredRows.value;
      return data.length ? data.at(-1) : null;
    });

    function deltaText(delta){
      if(!Number.isFinite(delta)) return '—';
      const r = Math.round(delta*10)/10;
      return (r>0?'+':'') + r.toFixed(1);
    }
    function deltaColor(delta, goodWhenDecrease){
      if(!Number.isFinite(delta)) return 'var(--muted)';
      const r = Math.round(delta*10)/10;
      const good = goodWhenDecrease ? (r<0) : (r>0);
      return good ? 'var(--good)' : 'var(--bad)';
    }

    const kpiItems = computed(()=>{
      const data = filteredRows.value;
      if(!data.length) return [];
      const start = data[0];
      const end = data.at(-1);
      const make = (key,label,unit,goodWhenDecrease)=>{
        const v = end[key];
        const d = (Number.isFinite(end[key]) && Number.isFinite(start[key])) ? (end[key]-start[key]) : null;
        return {
          key, label, unit,
          valueText: fmt1(v),
          deltaText: deltaText(d),
          deltaColor: deltaColor(d, goodWhenDecrease)
        };
      };
      return [
        make('weight_kg','体重','kg',true),
        make('bmi','BMI','',true),
        make('waist_cm','ウエスト','cm',true),
        make('bodyfat_pct','体脂肪率','%',true),
      ];
    });

    const metricTitleText = computed(()=> METRICS[currentMetric.value]?.name || currentMetric.value);

    // --- Charts ---
    let trendChart = null;
    let bodyMapChart = null;

    const targetLinePlugin = {
      id: 'targetLine',
      afterDatasetsDraw(chart){
        const key = currentMetric.value;
        const t = targets[key];
        if(!(Number.isFinite(+t))) return;
        const y = chart.scales.y.getPixelForValue(+t);
        const {left,right,top,bottom} = chart.chartArea;
        if(y < top || y > bottom) return;

        const ctx = chart.ctx;
        ctx.save();
        ctx.strokeStyle = 'rgba(124,255,140,.75)';
        ctx.lineWidth = 1;
        ctx.setLineDash([6,6]);
        ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = 'rgba(124,255,140,.9)';
        ctx.font = '12px -apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif';
        ctx.fillText('TARGET ' + (+t).toFixed(1), left+6, Math.max(top+14, y-6));
        ctx.restore();
      }
    };

    const bodyMapBg = {
      id: 'bodyMapBg',
      beforeDraw(chart){
        const {ctx, chartArea} = chart;
        if(!chartArea) return;
        const {left, right, top, bottom} = chartArea;

        ctx.save();
        ctx.fillStyle = 'rgba(255,255,255,0.02)';
        ctx.fillRect(left, top, right-left, bottom-top);

        const xScale = chart.scales.x;
        const yScale = chart.scales.y;

        const x = xScale.getPixelForValue(25);
        const y = yScale.getPixelForValue(25);

        ctx.strokeStyle = 'rgba(255,255,255,0.15)';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();

        ctx.fillStyle = 'rgba(159,176,214,0.75)';
        ctx.font = '12px -apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif';
        ctx.fillText('BMI 25', x+6, top+16);
        ctx.fillText('BF 25%', left+6, y-8);

        const h = targets.height_cm ? (+targets.height_cm/100) : null;
        const targetBf = targets.bodyfat_pct;
        let targetBmi = null;
        if(h && Number.isFinite(+targets.weight_kg)) targetBmi = +targets.weight_kg/(h*h);

        if(Number.isFinite(targetBf) && Number.isFinite(targetBmi)){
          const tx = xScale.getPixelForValue(targetBmi);
          const ty = yScale.getPixelForValue(targetBf);
          ctx.fillStyle = 'rgba(124,255,140,0.9)';
          ctx.beginPath(); ctx.arc(tx, ty, 4, 0, Math.PI*2); ctx.fill();
          ctx.fillText('TARGET', tx+8, ty-8);
        }
        ctx.restore();
      }
    };

    function ensureTrend(data){
      const labels = data.map(r=>r.date);
      const m = METRICS[currentMetric.value] || {name: currentMetric.value, unit:''};
      const values = data.map(r=>r[currentMetric.value]);
      const ctx = trendCanvas.value;
      if(!ctx) return;

      if(!trendChart){
        trendChart = new Chart(ctx, {
          type:'line',
          data:{ labels, datasets:[{
            label: m.name + (m.unit?` (${m.unit})`:``),
            data: values,
            tension: .35,
            pointRadius: 2,
            pointHoverRadius: 5,
            borderWidth: 2,
            fill: false
          }]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            layout:{ padding:{ bottom: 8 } },
            plugins:{ legend:{display:false}, tooltip:{ mode:'index', intersect:false } },
            interaction:{ mode:'index', intersect:false },
            scales:{
              x:{ ticks:{ color:'#9fb0d6', maxRotation:0, autoSkip:true }, grid:{ color:'rgba(255,255,255,.06)' } },
              y:{ ticks:{ color:'#9fb0d6' }, grid:{ color:'rgba(255,255,255,.06)' } }
            }
          },
          plugins:[targetLinePlugin]
        });
      }else{
        trendChart.data.labels = labels;
        trendChart.data.datasets[0].data = values;
        trendChart.data.datasets[0].label = m.name + (m.unit?` (${m.unit})`:``);
        trendChart.update();
      }
    }

    function ensureBodyMap(data){
      const pts = data
        .filter(r=>Number.isFinite(r.bmi) && Number.isFinite(r.bodyfat_pct))
        .map(r=>({x:r.bmi, y:r.bodyfat_pct, d:r.date}));

      const first = pts[0];
      const last = pts.at(-1);
      const ctx = bodyMapCanvas.value;
      if(!ctx) return;

      if(!bodyMapChart){
        bodyMapChart = new Chart(ctx, {
          type:'scatter',
          data:{ datasets:[
            { label:'推移', data:pts, pointRadius:3, pointHoverRadius:5 },
            { label:'開始', data:first?[first]:[], pointRadius:7, pointHoverRadius:8 },
            { label:'最新', data:last?[last]:[], pointRadius:7, pointHoverRadius:8 },
          ]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
              legend:{ labels:{ color:'#e8eefc' } },
              tooltip:{ callbacks:{ label:(c)=>` BMI ${c.raw.x.toFixed(1)} / BF ${c.raw.y.toFixed(1)}% (${c.raw.d||''})` } }
            },
            scales:{
              x:{ title:{display:true,text:'BMI',color:'#9fb0d6'}, ticks:{ color:'#9fb0d6' }, grid:{ color:'rgba(255,255,255,.06)' } },
              y:{ title:{display:true,text:'体脂肪率(%)',color:'#9fb0d6'}, ticks:{ color:'#9fb0d6' }, grid:{ color:'rgba(255,255,255,.06)' } },
            }
          },
          plugins:[bodyMapBg]
        });
      }else{
        bodyMapChart.data.datasets[0].data = pts;
        bodyMapChart.data.datasets[1].data = first?[first]:[];
        bodyMapChart.data.datasets[2].data = last?[last]:[];
        bodyMapChart.update();
      }
    }

    async function renderCharts(){
      const data = filteredRows.value;
      if(!data.length) return;
      await nextTick();
      if(currentView.value==='trend') ensureTrend(data);
      if(currentView.value==='bodymap') ensureBodyMap(data);
    }

    // Re-render on key changes
    watch([filteredRows, currentMetric, currentView], ()=>{ renderCharts(); }, {deep:false});
    watch(targets, ()=>{
      saveJson(TARGET_KEY_NEW, targets);
      if(trendChart) trendChart.update();
      if(bodyMapChart) bodyMapChart.update();
    }, {deep:true});

    // --- View / Metric ---
    function setRange(r){ currentRange.value = r; }
    function setView(v, via='direct'){
      currentView.value = v;
      if(v === 'trend'){
        if(via === 'direct') showMetricTabs.value = true;
      }else{
        showMetricTabs.value = false;
      }
      renderCharts();
    }
    function selectMetric(m){
      currentMetric.value = m;
      showMetricTabs.value = true;
      setView('trend','direct');
    }
    function openMetricFromMore(m){
      currentMetric.value = m;
      showMetricTabs.value = false;
      setView('trend','fromMore');
    }

    // --- Targets Modal ---
    function openTargetsModal(){
      targetsForm.weight_kg = Number.isFinite(+targets.weight_kg) ? (+targets.weight_kg).toFixed(1) : '';
      targetsForm.bmi = Number.isFinite(+targets.bmi) ? (+targets.bmi).toFixed(1) : '';
      targetsForm.waist_cm = Number.isFinite(+targets.waist_cm) ? (+targets.waist_cm).toFixed(1) : '';
      targetsForm.bodyfat_pct = Number.isFinite(+targets.bodyfat_pct) ? (+targets.bodyfat_pct).toFixed(1) : '';
      targetsForm.height_cm = targets.height_cm ? String(targets.height_cm) : '';
      showTargets.value = true;
    }
    function closeTargetsModal(){ showTargets.value = false; }
    function saveTargets(){
      const w = parseFloat(targetsForm.weight_kg);
      const b = parseFloat(targetsForm.bmi);
      const wa = parseFloat(targetsForm.waist_cm);
      const bf = parseFloat(targetsForm.bodyfat_pct);
      const h = parseFloat(targetsForm.height_cm);

      if(!Number.isNaN(w)) targets.weight_kg = w;
      targets.bmi = !Number.isNaN(b) ? b : null;
      targets.waist_cm = !Number.isNaN(wa) ? wa : null;
      if(!Number.isNaN(bf)) targets.bodyfat_pct = bf;
      targets.height_cm = (!Number.isNaN(h) && h>0) ? h : null;

      saveJson(TARGET_KEY_NEW, targets);
      showTargets.value = false;

      if(trendChart) trendChart.update();
      if(bodyMapChart) bodyMapChart.update();
    }

    // --- Add/Edit Modal ---
    function resetForm(){ Object.assign(form, emptyForm()); }
    function openAddModal(){
      editMode.value = false;
      editOriginalDate.value = null;
      resetForm();
      showAdd.value = true;
    }
    function closeAddModal(){ showAdd.value = false; }

    function openEdit(r){
      editMode.value = true;
      editOriginalDate.value = r.date;
      Object.assign(form, {
        date: r.date || '',
        weight_kg: r.weight_kg ?? '',
        bmi: r.bmi ?? '',
        waist_cm: r.waist_cm ?? '',
        bodyfat_pct: r.bodyfat_pct ?? '',
        fatmass_kg: r.fatmass_kg ?? '',
        visceral_fat_index: r.visceral_fat_index ?? '',
        skeletal_muscle_kg: r.skeletal_muscle_kg ?? '',
        bmr_kcal: r.bmr_kcal ?? '',
        limb_lean_mass_kg: r.limb_lean_mass_kg ?? '',
        muscle_kg: r.muscle_kg ?? '',
        fitness_score: r.fitness_score ?? ''
      });
      showAdd.value = true;
    }

    function computeBmiFromHeight(weightKg){
      const h = targets.height_cm ? (+targets.height_cm/100) : null;
      if(!h || !Number.isFinite(weightKg)) return null;
      return weightKg / (h*h);
    }

    function saveAdd(){
      const date = (form.date || '').trim();
      const weight = parseFloat(form.weight_kg);
      const bf = parseFloat(form.bodyfat_pct);
      const waist = parseFloat(form.waist_cm);

      let bmi = parseFloat(form.bmi);

      if(!date){ alert('日付を選んでね'); return; }
      if([weight, bf, waist].some(x=>Number.isNaN(x))) {
        alert('必須が足りないよ（体重/体脂肪率/ウエスト）');
        return;
      }

      if(Number.isNaN(bmi)){
        const calc = computeBmiFromHeight(weight);
        if(calc===null){
          alert('BMIが空なら、目標設定で身長(cm)を入れてね（自動計算する）');
          return;
        }
        bmi = calc;
      }

      const row = normalizeRow({
        date,
        weight_kg: weight,
        bmi: bmi,
        waist_cm: waist,
        bodyfat_pct: bf,
        fatmass_kg: parseFloat(form.fatmass_kg),
        visceral_fat_index: parseFloat(form.visceral_fat_index),
        skeletal_muscle_kg: parseFloat(form.skeletal_muscle_kg),
        bmr_kcal: parseFloat(form.bmr_kcal),
        limb_lean_mass_kg: parseFloat(form.limb_lean_mass_kg),
        muscle_kg: parseFloat(form.muscle_kg),
        fitness_score: parseFloat(form.fitness_score)
      });

      // optional NaNs -> null
      for(const k of ['fatmass_kg','visceral_fat_index','skeletal_muscle_kg','bmr_kcal','limb_lean_mass_kg','muscle_kg','fitness_score']){
        if(!row) break;
        if(Number.isNaN(+row[k])) row[k] = null;
      }

      let adds = loadAdds();
      let deleted = loadDeleted();

      if(editMode.value && editOriginalDate.value && editOriginalDate.value !== date){
        adds = adds.filter(r=>r.date !== editOriginalDate.value);
        if(!deleted.includes(editOriginalDate.value)) deleted.push(editOriginalDate.value);
      }

      adds = adds.filter(r=>r.date !== date);
      adds.push(row);

      saveAdds(adds);
      saveDeleted(deleted);

      rows.value = mergeRows();
      editMode.value = false;
      editOriginalDate.value = null;

      showAdd.value = false;
      renderCharts();
    }

    function deleteOne(){
      if(!editMode.value || !editOriginalDate.value) return;
      if(!confirm(`${editOriginalDate.value} のデータを削除する？`)) return;

      let adds = loadAdds().filter(r => r.date !== editOriginalDate.value);
      saveAdds(adds);

      let deleted = loadDeleted();
      if(!deleted.includes(editOriginalDate.value)) deleted.push(editOriginalDate.value);
      saveDeleted(deleted);

      rows.value = mergeRows();

      editMode.value = false;
      editOriginalDate.value = null;
      showAdd.value = false;
      renderCharts();
    }

    // --- List ---
    const listRows = computed(()=> {
      return filteredRows.value.slice().sort((a,b)=>b.date.localeCompare(a.date));
    });
    function openList(){ showList.value = true; }
    function closeList(){ showList.value = false; }
    function editRow(r){
      showList.value = false;
      openEdit(r);
    }

    // --- Import / Export ---
    function exportCsv(){
      const data = mergeRows();
      let csv = 'date,weight_kg,bmi,waist_cm,fatmass_kg,visceral_fat_index,bodyfat_pct,skeletal_muscle_kg,bmr_kcal,limb_lean_mass_kg,muscle_kg,fitness_score\n';
      data.forEach(r => {
        csv += [
          r.date || '',
          Number.isFinite(r.weight_kg) ? r.weight_kg : '',
          Number.isFinite(r.bmi) ? r.bmi : '',
          Number.isFinite(r.waist_cm) ? r.waist_cm : '',
          Number.isFinite(r.fatmass_kg) ? r.fatmass_kg : '',
          Number.isFinite(r.visceral_fat_index) ? r.visceral_fat_index : '',
          Number.isFinite(r.bodyfat_pct) ? r.bodyfat_pct : '',
          Number.isFinite(r.skeletal_muscle_kg) ? r.skeletal_muscle_kg : '',
          Number.isFinite(r.bmr_kcal) ? r.bmr_kcal : '',
          Number.isFinite(r.limb_lean_mass_kg) ? r.limb_lean_mass_kg : '',
          Number.isFinite(r.muscle_kg) ? r.muscle_kg : '',
          Number.isFinite(r.fitness_score) ? r.fitness_score : ''
        ].join(',') + '\n';
      });
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'progressfit_data.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function triggerImport(){
      if(!importInput.value) return;
      importInput.value.value = '';
      importInput.value.click();
    }

    function parseImportedText(text){
      const t = (text||'').trim();
      if(!t) throw new Error('empty');
      const lines = t.split(/\r?\n/).filter(Boolean);
      if(lines.length<2) throw new Error('no lines');
      const header = lines[0].split(',').map(h=>h.trim());
      const isInternal = header.includes('date') && header.includes('weight_kg');
      const mapJP = {
        '測定日':'date',
        '体重(㎏)':'weight_kg',
        'BMI':'bmi',
        'ウエスト':'waist_cm',
        '体脂肪量(㎏)':'fatmass_kg',
        '内臓脂肪指数':'visceral_fat_index',
        '体脂肪率(％)':'bodyfat_pct',
        '骨格筋量(㎏)':'skeletal_muscle_kg',
        '基礎代謝量(kcal)':'bmr_kcal',
        '四肢の除脂肪量(㎏)':'limb_lean_mass_kg',
        '四股の除脂肪量(㎏)':'limb_lean_mass_kg',
        '筋肉量(㎏)':'muscle_kg',
        'フィットネススコア':'fitness_score',
        'フィットネススコア(pt)':'fitness_score',
        'フィットネススコア (pt)':'fitness_score'
      };
      const mappedHeader = header.map(h => isInternal ? h : (mapJP[h] || h));

      const imported = [];
      for(let i=1;i<lines.length;i++) {
        const cols = lines[i].split(',');
        const obj = {};
        for(let j=0;j<mappedHeader.length;j++) obj[mappedHeader[j]] = (cols[j] ?? '').trim();
        const row = normalizeRow(obj);
        if(row) imported.push(row);
      }
      return imported;
    }

    function handleImportChange(e){
      const file = e?.target?.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (evt)=>{
        try{
          const text = (evt.target.result || '');
          const imported = parseImportedText(text);

          let adds = loadAdds();
          let deleted = loadDeleted();

          for(const row of imported){
            adds = adds.filter(r=>r.date !== row.date);
            adds.push(row);
            deleted = deleted.filter(d=>d !== row.date);
          }

          saveAdds(adds);
          saveDeleted(deleted);

          rows.value = mergeRows();
          renderCharts();
          alert('インポート完了しました');
        }catch(err){
          console.error(err);
          alert('CSVの読み込みに失敗しました');
        }
      };
      reader.readAsText(file);
    }

    async function exportPdf(){
      try{
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('PDFライブラリの読み込みに失敗しました'); return; }

        const all = mergeRows();
        if(!all.length){ alert('出力するデータがありません'); return; }

        // 直近1年
        const endDate = new Date(all.at(-1).date);
        const startDate = new Date(endDate);
        startDate.setFullYear(startDate.getFullYear() - 1);
        const rows1y = all.filter(r => new Date(r.date) >= startDate);
        if(!rows1y.length){ alert('出力するデータがありません'); return; }

        const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });

        async function createTextImage(text, fontSize, width, height) {
          const c = document.createElement('canvas');
          c.width = width; c.height = height;
          const ctx = c.getContext('2d');
          ctx.fillStyle = '#0D2340';
          ctx.fillRect(0, 0, c.width, c.height);
          ctx.fillStyle = '#ffffff';
          ctx.font = `${fontSize}px sans-serif`;
          ctx.textBaseline = 'middle';
          ctx.fillText(text, 5, height / 2);
          return c.toDataURL('image/png');
        }

        const from = rows1y[0].date;
        const to = rows1y[rows1y.length - 1].date;
        const titleImg = await createTextImage('ProgressFit レポート', 20, 600, 40);
        const periodImg = await createTextImage(`期間: ${from} ～ ${to} (直近1年)`, 12, 600, 30);

        function createChartImage(metricKey) {
          return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#0D2340';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const labels = rows1y.map(r=>r.date);
            const values = rows1y.map(r=> {
              const v = r[metricKey];
              return (v===null || v===undefined || Number.isNaN(v)) ? null : v;
            });

            const cfg = {
              type: 'line',
              data: {
                labels,
                datasets: [{
                  label: METRICS[metricKey].name + (METRICS[metricKey].unit ? ` (${METRICS[metricKey].unit})` : ''),
                  data: values,
                  fill: false,
                  tension: 0.1,
                  borderColor: '#6f97ff',
                  backgroundColor: '#6f97ff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: { enabled: false }
                },
                scales: {
                  x: {
                    ticks: { autoSkip: true, maxTicksLimit: 6, color: '#ffffff' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                  },
                  y: {
                    ticks: { color: '#ffffff' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                  }
                }
              }
            };

            const chart = new Chart(ctx, cfg);
            setTimeout(() => {
              const img = chart.toBase64Image();
              chart.destroy();
              resolve(img);
            }, 100);
          });
        }

        const metricsToExport = [...MAIN_METRICS, ...MORE_METRICS];
        let firstGraph = true;
        for(const m of metricsToExport){
          const imgData = await createChartImage(m);

          if(firstGraph){
            doc.setFillColor(13, 35, 64);
            doc.rect(0, 0, 210, 297, 'F');
            doc.addImage(titleImg, 'PNG', 10, 10, 190, 15);
            doc.addImage(periodImg, 'PNG', 10, 27, 190, 10);

            const metricTitleImg = await createTextImage(METRICS[m].name, 14, 600, 25);
            doc.addImage(metricTitleImg, 'PNG', 10, 40, 190, 10);
            doc.addImage(imgData, 'PNG', 10, 50, 190, 100);
            firstGraph = false;
          } else {
            doc.addPage();
            doc.setFillColor(13, 35, 64);
            doc.rect(0, 0, 210, 297, 'F');
            const metricTitleImg = await createTextImage(METRICS[m].name, 14, 600, 25);
            doc.addImage(metricTitleImg, 'PNG', 10, 10, 190, 10);
            doc.addImage(imgData, 'PNG', 10, 20, 190, 100);
          }
        }

        doc.save('progressfit_report.pdf');
      } catch(err) {
        console.error(err);
        alert('PDF生成に失敗しました');
      }
    }

    onMounted(()=>{
      // initial chart render
      renderCharts();
    });

    return {
      METRICS, MAIN_METRICS, MORE_METRICS, fmt1,

      // state
      currentRange, currentMetric, currentView, showMetricTabs,
      filteredRows, subtitle, latestRow, kpiItems, metricTitleText,

      // modals
      showTargets, showAdd, showList,
      targetsForm, form, addTitle, editMode,

      // lists
      listRows,

      // refs
      trendCanvas, bodyMapCanvas, importInput,

      // actions
      setRange, setView, selectMetric, openMetricFromMore,
      openTargetsModal, closeTargetsModal, saveTargets,
      openAddModal, closeAddModal, saveAdd, deleteOne,
      openList, closeList, editRow,
      exportCsv, triggerImport, handleImportChange, exportPdf
    };
}).mount('#app');
</script>
</body>
</html>
